<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Provider Dashboard | Best Hospice</title>
  <link rel="stylesheet" href="styles.css?v=15" />
  <style>
    body { background:#f3f6fb; }
    .dash-shell { max-width: 960px; margin:24px auto; padding:0 16px; }
    .dash-card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:20px; box-shadow:0 12px 24px rgba(15,23,42,0.08); display:grid; gap:16px; }
    .metrics { display:grid; gap:12px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
    .metric-card { background:#f8fbff; border:1px solid #e5e7eb; border-radius:12px; padding:14px; text-align:center; }
    .metric-card h4 { margin:0 0 6px; }
    .dash-btn { background:#fff; color:#1d4ed8; border:1px solid #bfdbfe; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; justify-self:end; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div class="dash-shell">
    <div class="dash-card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <div>
          <p id="welcome" style="margin:0; font-size:22px; font-weight:800;">Welcome to your Dashboard</p>
          <p id="provider-label" style="margin:0; color:#4b5563;"></p>
        </div>
        <button class="dash-btn" id="logout">Log out</button>
      </div>

      <div class="metrics">
        <div class="metric-card">
          <h4>Clients Best Hospice Has Connected You With</h4>
          <div id="m-total-notifs">-</div>
        </div>
      </div>

      <div style="border-top:1px solid #e5e7eb; padding-top:12px;">
        <h3>Lead Analytics</h3>
        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
          <label>Since <input id="since-date" type="date" /></label>
          <button class="dash-btn" id="load-leads">Load leads</button>
        </div>
        <div class="metrics" style="margin-top:12px;">
          <div class="metric-card"><h4>Leads since date</h4><div id="kpi-since">-</div></div>
          <div class="metric-card"><h4>Leads last 7 days</h4><div id="kpi-7d">-</div></div>
          <div class="metric-card"><h4>Leads last 30 days</h4><div id="kpi-30d">-</div></div>
        </div>
        <div style="margin-top:12px; overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:14px;">
            <thead>
              <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
                <th style="padding:8px;">Date received</th>
                <th style="padding:8px;">ZIP</th>
                <th style="padding:8px;">Submitted by</th>
                <th style="padding:8px;">Lead ID</th>
                <th style="padding:8px;">Contact Email</th>
                <th style="padding:8px;">Contact Phone</th>
                <th style="padding:8px;">Name</th>
              </tr>
            </thead>
            <tbody id="leads-body"></tbody>
          </table>
          <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
            <button class="dash-btn secondary" id="prev-page">Prev</button>
            <span id="page-info" style="font-weight:700;"></span>
            <button class="dash-btn secondary" id="next-page">Next</button>
          </div>
        </div>
      </div>

      <div style="border-top:1px solid #e5e7eb; padding-top:12px;">
        <h3>Performance</h3>
        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
          <label>Start <input id="perf-start" type="date" /></label>
          <label>End <input id="perf-end" type="date" /></label>
          <button class="dash-btn" id="load-perf">Load performance</button>
        </div>
        <div class="metrics" style="margin-top:12px;">
          <div class="metric-card"><h4>Impressions</h4><div id="perf-impr">-</div></div>
          <div class="metric-card"><h4>Emails Sent</h4><div id="perf-email">-</div></div>
          <div class="metric-card"><h4>Leads Generated</h4><div id="perf-leads">-</div></div>
        </div>
      </div>

      <div style="border-top:1px solid #e5e7eb; padding-top:12px; display:flex; justify-content:flex-start;">
        <div style="width:100%;">
          <h3>Manage Billing</h3>
          <div class="metrics" style="margin-top:8px;">
            <div class="metric-card"><h4>Monthly subscription</h4><div id="bill-monthly">$250</div></div>
            <div class="metric-card"><h4>Projected revenue from leads</h4><div id="bill-revenue">-</div></div>
          </div>
          <div style="margin-top:10px; display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
            <label style="font-weight:700;">Leads you converted to clients:
              <input id="converted-leads" type="number" min="0" value="0" style="margin-left:8px; padding:6px; border:1px solid #d1d5db; border-radius:8px; width:120px;">
            </label>
            <button class="dash-btn secondary" id="calc-converted">Calculate estimated revenue</button>
          </div>
          <div class="metric-card" style="margin-top:10px; max-width:320px;">
            <h4>Estimated revenue from converted leads</h4>
            <div id="converted-revenue">$0</div>
            <p style="margin:6px 0 0; font-size:12px; color:#4b5563;">$8,000 per client (market average hospice profit)</p>
          </div>
          <div style="margin-top:10px;">
            <button class="dash-btn" id="billing">Open Billing Portal</button>
          </div>
        </div>
      </div>

      <p id="status" style="color:#dc2626;"></p>
    </div>
  </div>

  <script>
    const tokenKey = 'provider_jwt';
    const statusEl = document.getElementById('status');
    let totalNotificationsCache = 0;

    function setStatus(msg){ statusEl.textContent = msg || ''; }

    async function callApi(path, method='GET', body){
      const token = localStorage.getItem(tokenKey) || '';
      if(!token){
        window.location.href = 'provider-dashboard.html';
        return;
      }
      const headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };
      const res = await fetch(path, { method, headers, body: body ? JSON.stringify(body): undefined });
      const data = await res.json().catch(()=>({}));
      if(!res.ok) throw new Error(data.error || 'Request failed');
      return data;
    }

    async function loadMetrics(){
      try{
        const data = await callApi('/api/provider-dashboard/metrics');
        document.getElementById('m-total-notifs').textContent = data.metrics.totalNotifications;
        totalNotificationsCache = data.metrics.totalNotifications || 0;
        document.getElementById('provider-label').textContent = data.provider ? data.provider.name + ' â€” ' + data.provider.email : '';
        document.getElementById('welcome').textContent = data.provider ? `Welcome to ${data.provider.name} Dashboard` : 'Welcome to your Dashboard';
        updateBillingCards();
        setStatus('');
      }catch(err){
        setStatus(err.message);
        localStorage.removeItem(tokenKey);
        window.location.href = 'provider-dashboard.html';
      }
    }

    let leadsPage = 1;

    async function loadLeadKPIs() {
      try {
        const sinceInput = document.getElementById('since-date').value;
        const since = sinceInput || new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
        const seven = new Date(Date.now() - 7*24*60*60*1000).toISOString().split('T')[0];
        const thirty = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];

        const [sinceCount, sevenCount, thirtyCount, leads] = await Promise.all([
          callApi(`/api/provider/leads/count?since=${since}`),
          callApi(`/api/provider/leads/count?since=${seven}`),
          callApi(`/api/provider/leads/count?since=${thirty}`),
          callApi(`/api/provider/leads?since=${since}&limit=10&page=${leadsPage}`)
        ]);
        document.getElementById('kpi-since').textContent = sinceCount.count;
        document.getElementById('kpi-7d').textContent = sevenCount.count;
        document.getElementById('kpi-30d').textContent = thirtyCount.count;
        const body = document.getElementById('leads-body');
        body.innerHTML = '';
        (leads.leads || []).forEach((l) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${(l.createdAt || '').toString().slice(0,10)}</td>
            <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${l.zip || ''}</td>
            <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${l.submittedBy || ''}</td>
            <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${l.leadId || ''}</td>
            <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${l.clientEmail || ''}</td>
            <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${l.clientPhone || ''}</td>
            <td style="padding:8px; border-bottom:1px solid #e5e7eb;">${l.clientName || ''}</td>
          `;
          body.appendChild(tr);
        });
        document.getElementById('page-info').textContent = `Page ${leads.page || 1} of ${Math.max(1, Math.ceil((leads.total || 0)/(leads.pageSize || 10)))}`;
        document.getElementById('prev-page').disabled = (leads.page || 1) <= 1;
        document.getElementById('next-page').disabled = (leads.page || 1) >= Math.max(1, Math.ceil((leads.total || 0)/(leads.pageSize || 10)));
      } catch (err) {
        setStatus(err.message);
      }
    }

    async function loadPerformance() {
      try {
        const start = document.getElementById('perf-start').value || new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
        const end = document.getElementById('perf-end').value || new Date().toISOString().split('T')[0];
        const data = await callApi(`/api/provider/metrics?start=${start}&end=${end}`);
        document.getElementById('perf-impr').textContent = data.impressions;
        document.getElementById('perf-email').textContent = data.emailsSent;
        document.getElementById('perf-leads').textContent = data.leadsGenerated;
      } catch (err) {
        setStatus(err.message);
      }
    }

    function updateBillingCards() {
      const revenue = totalNotificationsCache * 8000;
      document.getElementById('bill-revenue').textContent = revenue ? `$${revenue.toLocaleString()}` : '$0';
    }

    document.getElementById('logout').addEventListener('click', ()=>{
      localStorage.removeItem(tokenKey);
      window.location.href = 'provider-dashboard.html';
    });

    document.getElementById('load-leads').addEventListener('click', loadLeadKPIs);
    document.getElementById('prev-page').addEventListener('click', () => {
      if (leadsPage > 1) {
        leadsPage -= 1;
        loadLeadKPIs();
      }
    });
    document.getElementById('next-page').addEventListener('click', () => {
      leadsPage += 1;
      loadLeadKPIs();
    });
    document.getElementById('load-perf').addEventListener('click', loadPerformance);
    document.getElementById('billing').addEventListener('click', async () => {
      try {
        const data = await callApi('/api/provider/billing', 'POST');
        if (data.url) {
          window.location.href = data.url;
        } else {
          setStatus(data.error || 'Billing not available.');
        }
      } catch (err) {
        setStatus(err.message);
      }
    });
    document.getElementById('calc-converted').addEventListener('click', () => {
      const num = Math.max(0, parseInt(document.getElementById('converted-leads').value || '0', 10));
      const est = num * 8000;
      document.getElementById('converted-revenue').textContent = `$${est.toLocaleString()}`;
    });

    loadMetrics();
    loadLeadKPIs();
    loadPerformance();
  </script>
</body>
</html>
